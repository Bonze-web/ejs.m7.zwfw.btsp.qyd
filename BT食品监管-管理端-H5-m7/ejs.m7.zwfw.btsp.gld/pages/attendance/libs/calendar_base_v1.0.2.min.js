!function(){"use strict";function t(){}function e(t){t=mui.extend({},n,t),this.container=this._selector(t.container),this.containerWrapper=this._selector(t.containerWrapper),this.swiper=this._selector(t.swiper),this._initData(t)}var n={swiper:".swiper-container",container:".em-calendar-container",containerWrapper:".em-calendar-wrapper",isLunar:!0,isSwipeH:!0,isSwipeV:!0,swipeCallback:t,pre:".pre",preCallback:t,next:".next",nextCallback:t,itemClick:t,data:[],isDebug:!1};e.prototype={_initData:function(t){if(this.options=t,!this._validate())throw new Error("验证错误，日历的传入格式非法，请检查代码");this._initParams(),this._addEvent()},_initParams:function(){var t=this;t.newDate=new Date,t.nowYear=t.newDate.getFullYear(),t.nowMonth=t.newDate.getMonth()+1,t.nowDay=t.newDate.getDate();var e=new Date,n=e.getMonth()+1,a=e.getDate();t.currentDate=e.getFullYear()+"-"+t.tom(n)+"-"+t.tod(a),t.nowMonth=String(t.nowMonth),1==t.nowMonth.length&&(t.nowMonth="0"+t.nowMonth),t.CalendarData=new Array(100),t.madd=new Array(12),t.tgString="甲乙丙丁戊己庚辛壬癸",t.dzString="子丑寅卯辰巳午未申酉戌亥",t.numString="一二三四五六七八九十",t.monString="正二三四五六七八九十冬腊",t.weekString="日一二三四五六",t.sx="鼠牛虎兔龙蛇马羊猴鸡狗猪",t.cYear,t.cMonth,t.cDay,t.TheDate,t.CalendarData=new Array(2635,333387,1701,1748,267701,694,2391,133423,1175,396438,3402,3749,331177,1453,694,201326,2350,465197,3221,3402,400202,2901,1386,267611,605,2349,137515,2709,464533,1738,2901,330421,1242,2651,199255,1323,529706,3733,1706,398762,2741,1206,267438,2647,1318,204070,3477,461653,1386,2413,330077,1197,2637,268877,3365,531109,2900,2922,398042,2395,1179,267415,2635,661067,1701,1748,398772,2742,2391,330031,1175,1611,200010,3749,527717,1452,2742,332397,2350,3222,268949,3402,3493,133973,1386,464219,605,2349,334123,2709,2890,267946,2773,592565,1210,2651,395863,1323,2707,265877),t.madd[0]=0,t.madd[1]=31,t.madd[2]=59,t.madd[3]=90,t.madd[4]=120,t.madd[5]=151,t.madd[6]=181,t.madd[7]=212,t.madd[8]=243,t.madd[9]=273,t.madd[10]=304,t.madd[11]=334,this.refresh(t.nowYear,t.nowMonth,t.nowDay,document.querySelector(".swiper-slide").querySelector(".em-calendar-wrapper"))},refresh:function(t,e,n,a){var o=this;o.nowYear=parseInt(t),o.nowMonth=parseInt(e),o.nowDay=parseInt(n),o.nowMonth=o.tom(o.nowMonth),o.nowDay=o.tod(o.nowDay);var r=new Date(Date.parse(o.nowYear+"/"+o.nowMonth+"/01")),i=r.getDay();i=parseInt(i),0==i&&(i=7);var s=o._judgeDaysByYearMonth(o.nowYear,o.nowMonth);o.dayCount=s;var d={},h=[],u=o._judgeDaysByYearMonth(o.nowYear,o.nowMonth-1);u=parseInt(u);for(var l=1;l<i+1;l++){var c=u-i+l,w="day"+l,p="lunar"+l;d[w]=c,d[p]=o._getLunar(c,"m-1"),h.push({day:c,lunar:o._getLunar(c,"m-1"),date:o.nowYear+"-"+o.tom(o.nowMonth-1)+"-"+o.tod(c),isforbid:"0"})}var y=0;if("28"==s){y=28+i;for(var m=i+1,f=1;m<28+i+1;m++,f++){var w="day"+m,p="lunar"+m;d[w]=f,d[p]=o._getLunar(f),h.push({day:f,lunar:o._getLunar(f),date:o.nowYear+"-"+o.tom(o.nowMonth)+"-"+o.tod(f),isforbid:"1"})}}if("29"==s){y=29+i;for(var m=i+1,f=1;m<29+i+1;m++,f++){var w="day"+m,p="lunar"+m;d[w]=f,d[p]=o._getLunar(f),h.push({day:f,lunar:o._getLunar(f),date:o.nowYear+"-"+o.tom(o.nowMonth)+"-"+o.tod(f),isforbid:"1"})}}if("30"==s){y=30+i;for(var m=i+1,f=1;m<30+i+1;m++,f++){var w="day"+m,p="lunar"+m;d[w]=f,d[p]=o._getLunar(f),h.push({day:f,lunar:o._getLunar(f),date:o.nowYear+"-"+o.tom(o.nowMonth)+"-"+o.tod(f),isforbid:"1"})}}if("31"==s){y=31+i;for(var m=i+1,f=1;m<31+i+1;m++,f++){var w="day"+m,p="lunar"+m;d[w]=f,d[p]=o._getLunar(f),h.push({day:f,lunar:o._getLunar(f),date:o.nowYear+"-"+o.tom(o.nowMonth)+"-"+o.tod(f),isforbid:"1"})}}for(var g=y+1,D=1;g<=42;g++,D++){var w="day"+g,p="lunar"+g;d[w]=D,d[p]=o._getLunar(D,"m+1"),h.push({day:D,lunar:o._getLunar(D,"m+1"),date:o.nowYear+"-"+o.tom(parseInt(o.nowMonth)+parseInt(1))+"-"+o.tod(D),isforbid:"0"})}o.options.isDebug&&console.log("*********日历格式********:\n"+JSON.stringify(h)+"\n"),this._render(d,h,a)},_render:function(t,e,n){var a=this;a.getMySduleListTag(function(t){a.options.data=t||[],a.options.isDebug&&console.log("*********业务数据：********:\n"+JSON.stringify(a.options.data)+"\n");for(var o=0;o<a.options.data.length;o++)for(var r=0;r<e.length;r++)a.options.data[o].date==e[r].date&&(e[r].isSelected="1");var i="";i+=a.options.weekHeader(),i+=a.options.dayStartNode();for(var r=0,s=e.length;r<s;r++)i+=Mustache.render(a.options.dayTempl(e[r],a.currentDate),e[r]);i+=a.options.dayEndNode(),a.options.isDebug&&console.log("*********日历模板********:\n"+i+"\n"),n.innerHTML=i})},getMySduleListTag:function(t){var e=this,n=e.nowYear+"-"+e.nowMonth+"-",a={keyword:"",fromdatetime:n+"01 00:00:00",todatetime:n+"31 23:59:59"};common.ajax({url:"schedule_getlist_v7",data:a,dataPath:"custom.schedulelist",isShowWaiting:!1},function(n){var a=n.data,o=[];if(a&&Array.isArray(a)&&a.length>0){mui.each(a,function(t,e){e.time=DateUtil.getTime(e.fromdatetime,"hh:mm")+"-"+DateUtil.getTime(e.todatetime,"hh:mm"),o.push({date:DateUtil.getDate(e.fromdatetime,"yyyy-mm-dd")}),o.push({date:DateUtil.getDate(e.todatetime,"yyyy-mm-dd")})});var r=e.uniqueArray(o,"date");t&&t(r)}else t&&t([])},function(e){t&&t([]),ejs.ui.toast(Config.TIPS_II+"错误原因："+JSON.stringify(e))},{isDebug:!1})},uniqueArray:function(t,e){for(var n=[t[0]],a=1;a<t.length;a++){for(var o=t[a],r=!1,i=0;i<n.length;i++)if(o[e]==n[i][e]){r=!0;break}r||n.push(o)}return n},_addEvent:function(){var t=this,e=t.options.itemClick,n=t.options.swipeCallback,a=(t.options.preCallback,t.options.nextCallback,t.options.backToTodayCallback),o=new Swiper(".swiper-container",{loop:!0,cube:{slideShadows:!1,shadow:!1,shadowOffset:10,shadowScale:.6},onSlideNextStart:function(e){var a=e.activeIndex,o=e.slides[a];t.tmpActiveIndex=e.activeIndex,t.tmpSlideNode=e.slides[a],console.log("月份递减"+a),2==a?(t.nowMonth=parseInt(t.nowMonth)+parseInt(1),13==t.nowMonth&&(t.nowYear=t.nowYear+1,t.nowMonth=1),t.nowMonth=t.tom(t.nowMonth),t.nowDay=t.tod(t.nowDay),t.refresh(t.nowYear,t.nowMonth,t.nowDay,o),n&&n({year:t.nowYear,month:t.nowMonth,day:t.nowDay,dayCount:t.dayCount})):t.refresh(t.nowYear,t.nowMonth,t.nowDay,document.querySelector(".swiper-slide").querySelector(".em-calendar-wrapper"))},onSlidePrevStart:function(e){var a=e.activeIndex,o=e.slides[a];t.tmpActiveIndex=e.activeIndex,t.tmpSlideNode=e.slides[a],console.log("月份递增"+a),t.nowMonth=parseInt(t.nowMonth)-parseInt(1),0==t.nowMonth&&(t.nowYear=t.nowYear-1,t.nowMonth=12),t.nowMonth=t.tom(t.nowMonth),t.nowDay=t.tod(t.nowDay),t.refresh(t.nowYear,t.nowMonth,t.nowDay,o),n&&n({year:t.nowYear,month:t.nowMonth,day:t.nowDay,dayCount:t.dayCount})}});o.slideTo(0,1e3,!1),mui(".swiper-container").on("tap",".em-calendar-item",function(){if(!this.classList.contains("isforbid0")){Zepto(this).addClass("em-calendar-active").siblings().removeClass("em-calendar-active");var t=this.getAttribute("date");if(this.querySelector(".lunar"))var n=this.querySelector(".lunar").innerText.trim();else var n="已签";e&&e({date:t,lunar:n})}}),t._selector(t.options.pre)&&t._selector(t.options.pre).addEventListener("tap",function(){o.slidePrev()}),t._selector(t.options.next)&&t._selector(t.options.next).addEventListener("tap",function(){o.slideNext()}),t._selector(t.options.backToToday)&&t._selector(t.options.backToToday).addEventListener("tap",function(){var e=new Date,n=e.getFullYear(),r=t.tom(e.getMonth()+1),i=t.tod(e.getDate());t.refresh(n,r,i,t.tmpSlideNode),"1"==t.tmpActiveIndex||o.slideTo(1,1e3,!1),a&&a({year:n,month:r,day:i,date:n+"-"+r+"-"+i})})},_getLunar:function(t,e){var n=this,a=n.nowYear,o=n.nowMonth;o=parseInt(o),"m+1"===e&&(o=1+o,13==o&&(o=1)),"m-1"===e&&(o=-1+o,0==o&&(o=1));var r=t;new Date(Date.parse(a+"/"+o+"/"+r)).getDay();return this._getLunarDay(a,o,r)},_judgeDaysByYearMonth:function(t,e){var n=this;if(void 0==t||null==t)throw"=====获取当前月份天数时，缺少y参数，未定义！=======";if(void 0==e||null==e)throw"=====获取当前月份天数时，缺少m参数，未定义！=======";var t=parseInt(t),e=parseInt(e);return 0==e&&(t--,e=12),2==e?t%4==0&&t%100!=0||t%400==0?"29":"28":n._inArray(e,[1,3,5,7,8,10,12])?"31":"30"},_validate:function(){var t=!0;return this.options.container||(t=!1),t},_selector:function(t){return document.querySelector(t)},_inArray:function(t,e){if(!Array.isArray(e))throw"arguments is not Array";for(var n=0,a=e.length;n<a;n++)if(t==e[n])return!0;return!1},_sibling:function(t,e){for(var n=t.parentNode.firstChild;n;n=n.nextSibling)1===n.nodeType&&n!==t&&e&&"function"==typeof e&&e(n)},_getBit:function(t,e){return t>>e&1},_e2c:function(){var t=this;t.TheDate=3!=arguments.length?new Date:new Date(arguments[0],arguments[1],arguments[2]);var e,n,a,o,r=!1,i=t.TheDate.getYear();for(i<1900&&(i+=1900),e=365*(i-1921)+Math.floor((i-1921)/4)+t.madd[t.TheDate.getMonth()]+t.TheDate.getDate()-38,t.TheDate.getYear()%4==0&&t.TheDate.getMonth()>1&&e++,n=0;;n++){for(o=t.CalendarData[n]<4095?11:12,a=o;a>=0;a--){if(e<=29+t._getBit(t.CalendarData[n],a)){r=!0;break}e=e-29-t._getBit(t.CalendarData[n],a)}if(r)break}t.cYear=1921+n,t.cMonth=o-a+1,t.cDay=e,12==o&&(t.cMonth==Math.floor(t.CalendarData[n]/65536)+1&&(t.cMonth=1-t.cMonth),t.cMonth>Math.floor(t.CalendarData[n]/65536)+1&&t.cMonth--)},_getcDateString:function(){var t=this,e="";return t.cMonth<1,e+=t.cDay<11?"初":t.cDay<20?"十":t.cDay<30?"廿":"三十",t.cDay%10==0&&10!=t.cDay||(e+=t.numString.charAt((t.cDay-1)%10)),e},_getLunarDay:function(t,e,n){var a=this;return t<1921||t>2080?"":(e=parseInt(e)>0?e-1:11,a._e2c(t,e,n),a._getcDateString())},tom:function(t){return t=parseInt(t)>9?""+parseInt(t):"0"+parseInt(t)},tod:function(t){return t=parseInt(t)>9?""+parseInt(t):"0"+parseInt(t)},getTime:function(t){var e=new Date,n=e.getHours(),a=e.getMinutes(),o=e.getSeconds(),r="";return"hh:mm"==t?r+=n+":"+a:"hh:mm:ss"==t&&(r+=n+":"+a+":"+o),r}},window.Calendar2=e}();