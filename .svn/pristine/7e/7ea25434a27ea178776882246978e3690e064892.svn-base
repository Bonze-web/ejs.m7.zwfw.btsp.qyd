/**
 * 作者： 张金锁
 * 创建时间： 2021/04/06 14:57:36
 * 版本： [1.0]
 * 版权： 江苏国泰新点软件有限公司
 * 描述：食品留样
 */
(function (doc, Util) {
    'use strict';
    // var pripid = Util.getExtraDataByKey('pripid') || '';
    // var remainDate = Util.getExtraDataByKey('remainDate') || '';
    var pripid = '987654321123456789';
    var remainDate = '2021-02-19';

    //如果是新增食品留样，附件地址是随机数
    var uuid = Util.uuid();

    //1：新增 0：修改
    var isAdd = 1;

    Util.loadJs([, 'js/utils/util.charset.js'], function () {
        initListeners();
        getData();
    });

    /*
     * @description 点击事件
     */
    function initListeners() {
        $('body')
            //点击进入详情
            .on('tap', '.em-li', function () {
                var title = $(this).find('.breakfast_title').text();
                var length = $(this).find('.breakfast_detailed_list').children('li').length;
                if (length <= 0) {
                    //新增
                    isAdd = 1;
                } else {
                    //修改
                    isAdd = 0;
                }
                var time = $(this).find('.em-time').text();
                var handler = $(this).find('.em-handler').text();
                var rowguid = $(this).attr('remainguid');
                var remain_img = $(this).attr('remain_img');
                ejs.page.open('./samples_detail.html', {
                    title: Util.charset.base64.encode(title),
                    uuid: uuid,
                    isAdd: isAdd,
                    time: time,
                    handler: Util.charset.base64.encode(handler),
                    rowguid: rowguid,
                    pripid: pripid,
                    remain_img: remain_img
                });
            });
    }

    /*
     * @description 获取数据
     */
    function getData() {
        Util.ajax({
            url: Config.serverUrl + 'foodopt/getfoodoptremaininfo',
            data: JSON.stringify({
                token: 'Epoint_WebSerivce_**##0601',
                params: {
                    pripid: pripid,
                    remainDate: remainDate
                }
            }),
            headers: { 'Content-Type': 'application/json' },
            success: function (result) {
                if (result.custom.code == 1) {
                    var tmpInfo = result.custom,
                        template = document.getElementById('template').innerHTML,
                        html = '';
                    html = Mustache.render(template, tmpInfo);
                    document.getElementById('content').innerHTML = html;
                    var array = document.querySelectorAll('.em-ul li');
                    $.each(array, function (indexInArray, valueOfElement) {
                        var remainguid = $(valueOfElement).attr('remainguid');
                        getListData(remainguid, remainguid);
                    });
                    var x = 0,
                        y = 0,
                        z = 0;
                    if (array.length < 3) {
                        for (let index = 0; index < 3; index++) {
                            var atext = Zepto(array[index]).find('.breakfast_title').text();
                            if (atext == '早餐') {
                                x = 1;
                            } else if (atext == '午餐') {
                                y = 1;
                            } else if (atext == '晚餐') {
                                z = 1;
                            }
                        }
                        if (x == 0) {
                            $('.em-breakfast').removeClass('hidden');
                        }
                        if (y == 0) {
                            $('.em-lunch').removeClass('hidden');
                        }
                        if (z == 0) {
                            $('.em-dinner').removeClass('hidden');
                        }
                    }
                } else {
                    ejs.ui.toast(result.custom.text);
                }
            },
            error: function (error) {
                console.log('返回结果：' + JSON.stringify(error));
            }
        });
    }

    /*
     * @description 获取食品留样内容
     */
    function getListData(remainguid, key) {
        Util.ajax({
            url: Config.serverUrl + 'foodopt/getfoodoptremainfoodinfo',
            data: JSON.stringify({
                token: 'Epoint_WebSerivce_**##0601',
                params: {
                    remainguid: remainguid
                }
            }),
            headers: { 'Content-Type': 'application/json' },
            success: function (result) {
                if (result.custom.code == 1) {
                    var tmpInfo = result.custom.foodoptremainfoodinfo,
                        template = document.getElementById('template-food').innerHTML,
                        html = '';
                    if (tmpInfo && Array.isArray(tmpInfo) && tmpInfo.length > 0) {
                        $.each(tmpInfo, function (index, item) {
                            html += Mustache.render(template, item);
                        });
                    } else {
                        ejs.ui.toast('数据不存在或返回数据的格式错误！');
                    }
                    document.getElementById('listdata-food' + key).innerHTML = html;
                } else {
                    ejs.ui.toast(result.custom.text);
                }
            },
            error: function (error) {
                console.log('返回结果：' + JSON.stringify(error));
            }
        });
    }
})(document, window.Util);
