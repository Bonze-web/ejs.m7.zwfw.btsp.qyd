/**
    作者 :lujun
    创建时间 :2021/03/31
    版本 :[1.0, 2021/03/31]
    版权：江苏国泰新点软件有限公司
    描述：风险分级评定
 **/

(function (d, $) {
    'use strict';

    var token = Config.token,
        status = '待接收',
        minirefreshObj = null; // 下拉刷新实例

    Util.loadJs(
        // 下拉刷新
        'js/widgets/minirefresh/minirefresh.css',
        'js/widgets/minirefresh/minirefresh.js',
        'js/widgets/minirefresh/themes/native/minirefresh.theme.native.js',
        'js/widgets/minirefresh/minirefresh.bizlogic.js',
        function () {
            ejs.config({
                jsApiList: []
            });

            ejs.ready(function () {
                initPage()
            });
        }
    );

    // 初始化页面信息
    function initPage() {
        // 初始化事件监听
        initListeners();
        // 下拉刷新
        pullToRefresh();
    }

    /**
     * 初始化事件监听
     */
    function initListeners() {
        $('body')
            // 点击tab切换
            .on('tap', '.daily-tab div', function (e) {
                $('.active').removeClass('active');
                $(this).addClass('active');
                status = $(this).text();
                $('#statusbtn').text($(this).text().split('待')[1])
                minirefreshObj.refresh();
            })
            // 点击li 跳转
            .on('tap', '#listdata li', function (e) {

                var target = e.detail.target,
                    tabText = $('.active').text(),
                    url = 'risk_overcheckdetail';
                console.log(target.id)

                //为底部按钮时
                if (target.id == 'statusbtn') {
                    url = $(target).text() == '反馈' ? 'risk_feedback' : '';
                } else {
                    if (tabText == '待接收' || tabText == '待反馈') {
                        url = 'risk_receiveddetail'
                    }
                }

                if (url)
                    ejs.page.open({
                        pageUrl: `./${url}.html`,
                        pageStyle: 1,
                        orientation: 1,
                        data: {
                            status: encodeURI(tabText)
                        },
                        success: function (result) {

                        },
                        error: function (error) { }
                    });
            })
    }

    /**
     * 下拉刷新
     * @param {String} url 接口地址
     */
    function pullToRefresh() {
        minirefreshObj = new MiniRefreshBiz({
            url: Config.healthAppUrl + 'scjgjtakan/getHandleTakanList',
            template: '#infolist-tpl',
            initPageIndex: 1,
            listContainer: '#listdata',
            contentType: 'application/json;charset=UTF-8',
            // contentType: 'application/x-www-form-urlencoded',
            dataRequest: function (currPage) {
                var requestData = JSON.stringify({
                    params: {
                        currentpageindex: currPage.toString(),
                        pagesize: '10',
                        checkform: "风险评定",//检查形式:区分 日常、专项、风险评定
                        searchkey: "",//非必填 搜索框查询条件（任务名称或者任务编码）
                        status: status //非必填 状态查询条件
                    }
                });

                // console.log(requestData);

                return requestData;
            },
            dataChange: function (res) {
                // console.log(JSON.stringify(res), res);

                return res.custom.takanlist;
            },
            success: function (res) { },
            itemClick: function (e) {

            },
            error: function (err) {
                ejs.ui.toast(JSON.stringify(err));
            }
        });
    }
})(document, Zepto);