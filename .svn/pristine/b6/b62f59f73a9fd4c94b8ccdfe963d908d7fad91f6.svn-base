/**
 * ä½œè€…ï¼š å¼ é‡‘é”
 * åˆ›å»ºæ—¶é—´ï¼š 2021/04/06 18:10:36
 * ç‰ˆæœ¬ï¼š [1.0]
 * ç‰ˆæƒï¼š æ±Ÿè‹å›½æ³°æ–°ç‚¹è½¯ä»¶æœ‰é™å…¬å¸
 * æè¿°ï¼šæ¸…æ´—æ¶ˆæ¯’
 */
(function (doc, Util) {
    'use strict';

    var miniRefreshObj;

    // var clean_date = '2021-02-19';
    var pripid = '';
    var clean_date = Util.getExtraDataByKey('date');

    Util.loadJs(
        ['pages/common/common.js', 'js/widgets/minirefresh/minirefresh.css', 'js/widgets/minirefresh/minirefresh.js'],
        ['js/widgets/minirefresh/minirefresh.bizlogic.js'],
        function () {
            initPage();
        }
    );

    /*
     * @description è·å–pripid
     */
    function initPage() {
        common.commGetUserInfo(function (res) {
            console.log("ğŸš€ ~ file: news_index.js ~ line 30 ~ res", res)
            pripid = res;
            initListeners();
            getData();
        })
    }

    /*
     * @description ç‚¹å‡»äº‹ä»¶
     */
    function initListeners() {
        $('body')
            //æ–°å¢
            .on('tap', '.em-btn', function () {
                ejs.page.open(
                    Config.serverUrl.replace(/rest\//, '') +
                    'frame/fmui/pages/jyqyinfo/ejgtyzfobjfoodoptclean/ejgtyzfobjfoodoptcleanadd?cleanDate=' +
                    clean_date
                );
            })
            //åˆ é™¤
            .on('tap', '.em-delete', function (item) {
                var rowguid = $(this).parent().attr('rowguid');
                ejs.ui.confirm({
                    title: 'æ˜¯å¦é€‰æ‹©',
                    message: 'ç¡®å®šåˆ é™¤ï¼Ÿ',
                    buttonLabels: ['å–æ¶ˆ', 'ç¡®å®š'],
                    cancelable: 1,
                    h5UI: false, // æ˜¯å¦å¼ºåˆ¶ä½¿ç”¨H5-UIæ•ˆæœï¼Œé»˜è®¤false
                    success: function (result) {
                        if (result.which == 1) {
                            deleteData(rowguid);
                            // item.target.parentNode.remove();
                        }
                    },
                    error: function (err) { }
                });
            })
            //è¯¦æƒ…
            .on('tap', '.em-time,.em-main', function () {
                var rowguid = $(this).parent().attr('rowguid');
                ejs.page.open(
                    Config.serverUrl.replace(/rest\//, '') +
                    'frame/fmui/pages/jyqyinfo/ejgtyzfobjfoodoptclean/ejgtyzfobjfoodcleandetail?guid=' +
                    rowguid
                );
            })
            //ä¿®æ”¹
            .on('tap', '.em-rename', function () {
                var rowguid = $(this).parent().attr('rowguid');
                ejs.page.open(
                    Config.serverUrl.replace(/rest\//, '') +
                    'frame/fmui/pages/jyqyinfo/ejgtyzfobjfoodoptclean/ejgtyzfobjfoodoptcleanedit?guid=' +
                    rowguid
                );
            });
    }

    /*
     * @description åˆ é™¤ä¼ä¸šæ¸…æ´—æ¶ˆæ¯’ä¿¡æ¯
     */
    function deleteData(rowguid) {
        Util.ajax({
            url: Config.serverUrl + 'foodopt/getfoodoptcleandelete',
            data: JSON.stringify({
                token: 'Epoint_WebSerivce_**##0601',
                params: {
                    rowguid: rowguid
                }
            }),
            headers: { 'Content-Type': 'application/json' },
            success: function (result) {
                if (result.custom.code == 1) {
                    ejs.ui.toast(result.custom.text);
                    miniRefreshObj.refresh();
                } else {
                    ejs.ui.toast(result.custom.text);
                }
            },
            error: function (error) {
                console.log('è¿”å›ç»“æœï¼š' + JSON.stringify(error));
            }
        });
    }

    /*
     * @description è·å–åˆ—è¡¨æ•°æ®
     */
    function getData() {
        miniRefreshObj = new MiniRefreshBiz({
            container: '#minirefresh',
            isDebug: false,
            contentType: 'application/json;charest=UTF-8',
            timeout: null,
            url: Config.serverUrl + 'foodopt/getfoodoptcleaninfo',
            dataRequest: function (currPage) {
                var data = {
                    clean_date: clean_date,
                    pripid: pripid,
                    pagesize: '10',
                    currentpage: currPage * 10
                };
                var requestData = JSON.stringify({
                    token: 'Epoint_WebSerivce_**##0601',
                    params: data
                });
                return requestData;
            },
            template: function () {
                var template = document.getElementById('template').innerHTML;
                return template;
            },
            dataChange: function (result) {
                if (result.custom.code == '1') {
                    var tmpInfo = result.custom.foodoptcleanlist;
                } else {
                    ejs.ui.toast(result.custom.text);
                }
                return tmpInfo;
            },
            success: function (res, isPulldown) {
                if (isPulldown) {
                    if (res) {
                        if (res.length <= 0) {
                            $('.em-tips').removeClass('hidden');
                            $('.minirefresh-upwrap').hide();
                            $('.downwrap-content').hide();
                        } else {
                            $('.em-tips').addClass('hidden');
                            $('.minirefresh-upwrap').show();
                            $('.downwrap-content').show();
                        }
                    }
                }
            }
        });
    }
})(document, window.Util);
