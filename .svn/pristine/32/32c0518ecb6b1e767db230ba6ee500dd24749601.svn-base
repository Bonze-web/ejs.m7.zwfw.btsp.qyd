!function(doc,Util,stringTools){"use strict";var formInstance=null,defaultSetting={tag:"input",errCls:""},defaultPrompt={phone:"手机号码格式不正确",email:"邮箱格式不正确",tel:"电话号码格式不正确",idcard:"身份证输入不正确",required:function(e){return e+"不能为空"},maxlength:function(e){return this.innerHTML+"不能大于"+e+"位"},minlength:function(e){return this.innerHTML+"不能小于"+e+"位"},regexp:function(){return this.innerHTML+"输入不正确"},equal:function(){return"密码输入不一致，请重新输入"}},registerMethod=[];function Form(e,t){var r=this;t=t||{},r.options=Util.extend(defaultSetting,t),r.container=Util.selector(e),r.validatorEl=r.getValidatorEl(r.options.tag),r.ruleMethod={range:r._handleRange,maxlength:r._handleMaxlength,minlength:r._handleMinlength,phone:stringTools.isPhone.bind(this),tel:stringTools.isTel.bind(this),email:stringTools.isEmail.bind(this),idcard:stringTools.idCard.bind(this)},0<registerMethod.length&&r._ruleMergeMethod(registerMethod)}Form.prototype={validate:function(){return this._handleRuleType(this.validatorEl)},getData:function(){var e=this.validatorEl,r={};return e.forEach(function(e){var t=e.dataset;t.id?r[t.id]=e.value||"":t.name&&(r[t.name]=e.value||"")}),r},getError:function(){return this.error},getValidatorEl:function(e){e=e.trim();var r=[],n=this.container,e=e.split(";");return Array.isArray(e)&&e.forEach(function(e,t){r=r.concat([].slice.call(n.querySelectorAll(e)))}),r},reset:function(){for(var e=this.validatorEl,t=0,r=e.length;t<r;t++)e[t].value=""},setDefaultErrMsg:function(e){defaultPrompt=Util.extend(defaultPrompt,e)},_handleRuleType:function(e){for(var t=this,r=0,n=e.length,l=t._handleRequire,i=t._handleVType;r<n;r++){var a,o,s=e[r],u=s.hasAttribute("vtype");if(s.required){if(!l.call(t,s))return!1;if(u&&!i.call(t,s))return!1}else{if(""!=s.value&&u&&!i.call(t,s))return!1;u&&~s.getAttribute("vtype").indexOf("equal")&&(o=(a=s.getAttribute("vtype")).indexOf("equal:")+6,-1==a.indexOf(";",o)?t._handleEqual.call(t,s,a.slice(o)):t._handleEqual.call(t,s,a.slice(o,a.indexOf(";",o))))}}return!0},_handleRequire:function(e){return!(!e.value||""==e.value)||(this._handleError(e,defaultPrompt.required,this.options.errCls),!1)},_handleVType:function(e){var t=e.getAttribute("vtype"),r=this,n=r.ruleMethod;if(""!=t&&/^[a-z]+:/i.test(t)){for(var l=0,i=(t=(t=t.toLowerCase().trim()).split(";")).length;l<i;l++){var a=t[l],o=a.slice(0,a.indexOf(":"));if(n[o]&&!n[o].call(r,e,a))return!1;if("regtype"==o&&!r._handleRegType(e,a))return!1;if("regexp"==o&&!r._handleRegExp(e,a))return!1;if("equal"==o&&!r._handleEqual(e,a))return!1}return!0}},_handleRegType:function(e,t){var r=this,n=r.ruleMethod,l=(e.previousElementSibling,n[t=this._analysisVtype(t)]);if("function"==typeof l)return"m7_util_form_custom_regtype"===l.type?!!r._handleCustomRegType(e,l):!!l(e.value)||(r._handleError(e,defaultPrompt[t],r.options.errCls),!1);throw new Error("未找到改判定条件")},_handleCustomRegType:function(e,t){for(var r=t.regTypeName,n=null,l=0,i=registerMethod.length;l<i;l++){var a=registerMethod[l];r==a.callback.regTypeName&&(n=a.param,t=t.bind(e,a.param))}return!!t()||(this._handleError(e,n,n.errCls),!1)},_handleRegExp:function(el,vtype){var self=this,labelEle=el.previousElementSibling;return vtype=self._analysisVtype(vtype),vtype=eval(vtype),!!vtype.test(el.value)||(self._handleError(el,defaultPrompt.regexp(labelEle),self.options.errCls),!1)},_handleEqual:function(e,t){var r=e.value,t=this._analysisVtype(t);return r==(doc.getElementById(t)||doc.querySelector("[data-id='"+t+"']")).value||(this._handleError(e,defaultPrompt.equal(),this.options.errCls),!1)},_handleRange:function(e,t){e.previousElementSibling;var r=Boolean(-1==t.indexOf(",")),n=t.slice(t.indexOf(":")+1,r?t.length:t.indexOf(",")),l=r?"":t.slice(t.indexOf(",")+1);return!!this._handleMinlength(e,"",n)&&!!this._handleMaxlength(e,"",l)},_handleMinlength:function(e,t,r){var n=e.value.length,l=e.previousElementSibling;return t&&(r=this._analysisVtype(t)),!(n<r)||(this._handleError(e,defaultPrompt.minlength(l,r),this.options.errCls),!1)},_handleMaxlength:function(e,t,r){var n=e.value.length,l=e.previousElementSibling;return t&&(r=this._analysisVtype(t)),!(r<n)||(this._handleError(e,defaultPrompt.maxlength(l,r),this.options.errCls),!1)},_ruleMergeMethod:function(e){var n=this;e.forEach(function(e){var t=e.callback,r=e.name;t.type="m7_util_form_custom_regtype",t.regTypeName=r,n.ruleMethod[r]=t})},_handleErrCls:function(e,t){if(t&&""!=t){for(var r=e.parentElement;r&&!r.hasAttribute("data-role");)r=r.parentElement;r&&r.hasAttribute("data-role")&&r.classList.add(t)}},_analysisVtype:function(e){return e=(e=e.trim().replace(/\s/g,"")).slice(e.indexOf(":")+1)},_handleError:function(e,t,r){var n=e.previousElementSibling,l="";e.dataset&&e.dataset.title?l=e.dataset.title:"label"==n.tagName.toLowerCase()&&(l=n.innerHTML),"function"==typeof t?t=t.call(e,l):"object"==typeof t&&(t=t.errMsg||""),this._setError(e,t),this.toast(t),this._handleErrCls(e,r)},_setError:function(e,t){this.error={dom:e,message:t}},toast:function(e){e&&Util.ejs.ui.toast(e)},isEmptyObject:function(e){for(var t in e)return!1;return!0},registerVtype:function(e,t,r){registerMethod.push({callback:r,param:t,name:e}),this._ruleMergeMethod(registerMethod)}},Util.form={getInstance:function(e,t){return formInstance=new Form(e,t)},registerVtype:function(e,t){var r=t.callback;delete t.callback,formInstance?formInstance.registerVtype(e,t,r):registerMethod.push({callback:r,param:t,name:e})},setDefaultErrMsg:function(e){defaultPrompt=Util.extend(defaultPrompt,e)}}}(document,this.Util,this.Util.string);