/**
 * ä½œè€…ï¼š å¼ é‡‘é”
 * åˆ›å»ºæ—¶é—´ï¼š 2021/04/06 14:57:36
 * ç‰ˆæœ¬ï¼š [1.0]
 * ç‰ˆæƒï¼š æ±Ÿè‹å›½æ³°æ–°ç‚¹è½¯ä»¶æœ‰é™å…¬å¸
 * æè¿°ï¼šæ¯æ—¥èœè°±
 */
(function (doc, Util) {
    'use strict';

    var rowguid = '';
    // var menu_date = '2021-02-19';
    var pripid = '';
    var menu_date = Util.getExtraDataByKey('date');

    Util.loadJs(['pages/common/common.js'], function () {
        initPage();

    });

    /*
     * @description è·å–pripid
     */
    function initPage() {
        common.commGetUserInfo(function (res) {
            console.log("ğŸš€ ~ file: news_index.js ~ line 30 ~ res", res)
            pripid = res.loginid;
            initListeners();
            getTabData();
        })
    }

    /*
     * @description ç‚¹å‡»äº‹ä»¶
     */
    function initListeners() {
        $('body')
            //é€‰æ‹©æ—©é¤ã€åˆé¤è¿˜æ˜¯æ™šé¤
            .on('tap', '.em-tab-selector', function () {
                $(this).addClass('em-active0').siblings().removeClass('em-active0');
                getTypeData();
            })
            //æ–°å¢ä¸»é£Ÿé¡µ
            .on('tap', '.em-add-icon', function () {
                var foodtype = $(this).parent().parent().attr('itemvalue');
                var menuguid = $(this).parent().parent().find('.em-item').attr('menuguid');
                ejs.page.open(
                    Config.serverUrl.replace(/rest\//, '') +
                    'frame/fmui/pages/jyqyinfo/ejgtyzfobjfoodoptmenufood/ejgtyzfobjfoodoptmenufoodadd?menuguid=' +
                    menuguid +
                    '&foodType=' +
                    foodtype
                );
            })
            //åˆ é™¤èœè°±å†…å®¹
            .on('tap', '.em-delete', function (item) {
                var rowguid = $(this).parent().attr('rowguid');
                ejs.ui.confirm({
                    title: 'æ˜¯å¦é€‰æ‹©',
                    message: 'ç¡®å®šåˆ é™¤ï¼Ÿ',
                    buttonLabels: ['å–æ¶ˆ', 'ç¡®å®š'],
                    cancelable: 1,
                    h5UI: false, // æ˜¯å¦å¼ºåˆ¶ä½¿ç”¨H5-UIæ•ˆæœï¼Œé»˜è®¤false
                    success: function (result) {
                        if (result.which == 1) {
                            item.target.parentNode.remove();
                            deleteData(rowguid);
                        }
                    },
                    error: function (err) { }
                });
            })
            //å†…å®¹è¯¦æƒ…é¡µ
            .on('tap', '.em-type', function () {
                var guid = $(this).parent().attr('rowguid');
                ejs.page.open(
                    Config.serverUrl.replace(/rest\//, '') +
                    'frame/fmui/pages/jyqyinfo/ejgtyzfobjfoodoptmenufood/ejgtyzfobjfoodoptmenufooddetail?guid=' +
                    guid
                );
            });
    }

    /*
     * @description åˆ é™¤èœè°±å†…å®¹
     */
    function deleteData(rowguid) {
        Util.ajax({
            url: Config.serverUrl + 'foodopt/getfoodoptmenufooddelete',
            data: JSON.stringify({
                token: 'Epoint_WebSerivce_**##0601',
                params: {
                    rowguid: rowguid
                }
            }),
            headers: { 'Content-Type': 'application/json' },
            success: function (result) {
                if (result.custom.code == 1) {
                    ejs.ui.toast(result.custom.text);
                    getTabData();
                } else {
                    ejs.ui.toast(result.custom.text);
                }
            },
            error: function (error) {
                console.log('è¿”å›ç»“æœï¼š' + JSON.stringify(error));
            }
        });
    }

    /*
     * @description è·å–tabæ æ•°æ®
     */
    function getTabData() {
        Util.ajax({
            url: Config.serverUrl + 'foodopt/getfoodoptmenuinfo',
            data: JSON.stringify({
                token: 'Epoint_WebSerivce_**##0601',
                params: {
                    menu_date: menu_date,
                    pripid: pripid,
                    pagesize: '999',
                    currentpage: '0'
                }
            }),
            headers: { 'Content-Type': 'application/json' },
            success: function (result) {
                if (result.custom.code == 1) {
                    var tmpInfo = result.custom.foodoptmenulist,
                        template = document.getElementById('template-tab').innerHTML,
                        html = '';
                    var indexa = '';
                    $.each(tmpInfo, function (index, item) {
                        item.indexa = index;
                        html += Mustache.render(template, item);
                    });
                    document.getElementById('listdata-tab').innerHTML = html;
                    getTypeData();
                } else {
                    ejs.ui.toast(result.custom.text);
                }
            },
            error: function (error) {
                console.log('è¿”å›ç»“æœï¼š' + JSON.stringify(error));
            }
        });
    }

    /*
     * @description è·å–èœè°±ç±»å‹æ•°æ®
     */
    function getTypeData() {
        Util.ajax({
            url: Config.serverUrl + 'commonInter/getCodeInfoList',
            data: JSON.stringify({
                token: 'Epoint_WebSerivce_**##0601',
                params: {
                    codename: 'é…é¤ç±»å‹'
                }
            }),
            headers: { 'Content-Type': 'application/json' },
            success: function (result) {
                if (result.status.code == 1) {
                    var tmpInfo = result.custom.codelist,
                        template = document.getElementById('template-type').innerHTML,
                        html = '';
                    var foodTypeList = [];
                    $.each(tmpInfo, function (index, item) {
                        foodTypeList.push(item.itemvalue);
                        item.a1 = index;
                        html += Mustache.render(template, item);
                    });
                    document.getElementById('listdata-type').innerHTML = html;
                    var key = 0;
                    $.each(foodTypeList, function (indexInArray, valueOfElement) {
                        key = indexInArray;
                        getListData(valueOfElement, key);
                    });
                } else {
                    ejs.ui.toast(result.status.text);
                }
            },
            error: function (error) {
                console.log('è¿”å›ç»“æœï¼š' + JSON.stringify(error));
            }
        });
    }

    /*
     * @description è·å–åˆ—è¡¨æ•°æ®
     */
    function getListData(foodtype, key) {
        rowguid = $('.em-active0').attr('rowguid');
        Util.ajax({
            url: Config.serverUrl + 'foodopt/getfoodoptmenufoodinfo',
            data: JSON.stringify({
                token: 'Epoint_WebSerivce_**##0601',
                params: {
                    menuguid: rowguid,
                    food_type: foodtype
                }
            }),
            headers: { 'Content-Type': 'application/json' },
            success: function (result) {
                if (result.custom.code == 1) {
                    var tmpInfo = result.custom.foodoptmenufoodinfo,
                        template = document.getElementById('template').innerHTML,
                        html = '';
                    $.each(tmpInfo, function (index, item) {
                        html += Mustache.render(template, item);
                    });
                    document.getElementById('listdata' + key).innerHTML = html;
                } else {
                    ejs.ui.toast(result.custom.text);
                }
            },
            error: function (error) {
                console.log('è¿”å›ç»“æœï¼š' + JSON.stringify(error));
            }
        });
    }
})(document, window.Util);
